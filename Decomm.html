<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Decommissioning Plan</title>
    <link rel="stylesheet" href="Decomm-styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div id="banner">
        <img src="CEVA_BlueRed.jpg" alt="CEVA Logistics" id="banner-logo">
        <h1>Decommissioning Planning Tool</h1>
    </div>
    
    <div class="container">
        <div class="header">
            <button class="back-button" onclick="window.close()">‚Üê Back</button>
            
            <h1 style="color: white;">Decommissioning Plan</h1>
            <p>Plan and track application decommissioning activities</p>
        </div>
        
        <div class="comparison-area">
            <!-- Summary Section -->
            <div id="summary-section" style="background:#f8f9fa; border:2px solid #1976d2; border-radius:12px; padding:20px; margin-bottom:30px;">
                <h3 style="text-align:center; color:#1976d2; margin-top:0; margin-bottom:20px;">Decommissioning Overview</h3>
                <div id="year-summary-table" style="overflow-x:auto;">
                    <table style="width:100%; border-collapse:collapse; background:#fff; font-size:1.3em;">
                        <thead>
                            <tr style="background:#f0f4fa; color:#1976d2;">
                                <th style="padding:14px 10px; border-bottom:3px solid #1976d2; font-size:1em;">Year</th>
                                <th style="padding:14px 10px; border-bottom:3px solid #1976d2; font-size:1em;">Retire</th>
                                <th style="padding:14px 10px; border-bottom:3px solid #1976d2; font-size:1em;">Replace</th>
                                <th style="padding:14px 10px; border-bottom:3px solid #1976d2; font-size:1em;">TCO ($)</th>
                            </tr>
                        </thead>
                        <tbody id="year-summary-tbody">
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Slider Navigation -->
            <div style="display:flex; justify-content:center; gap:20px; margin-bottom:20px;">
                <button id="btnView1" class="slider-btn active" onclick="showView(1)">Bar Chart by Region</button>
                <button id="btnView2" class="slider-btn" onclick="showView(2)">Sunset Roadmap</button>
                <button id="btnView4" class="slider-btn" onclick="showView(4)">TCO Optimization FLow</button><button id="btnView3" class="slider-btn" onclick="showView(3)">Decomm Plan Table</button>
                
            </div>
            
            <!-- View 1: Bar Chart -->
            <div id="view1" class="chart-view">
                <div style="background:#fff; border:1px solid #ddd; border-radius:16px; box-shadow:0 2px 12px #0002; padding:30px; margin-bottom:30px;">
                    <h3 style="text-align:center; color:#1976d2; margin-bottom:20px;">Decommissioning Plan by Year (2025-2028)</h3>
                    <canvas id="decommChart" width="800" height="400"></canvas>
                </div>
            </div>
            
            <!-- Details section for bar chart -->
            <div id="bar-chart-details" style="display:none; margin-top:20px; padding:20px; background:#f5f5f5; border-radius:8px;">
                <div id="bar-chart-details-content"></div>
            </div>
            
            <!-- View 2: Gantt Chart -->
            <div id="view2" class="chart-view" style="display:none;">
                <div style="background:#fff; border:1px solid #ddd; border-radius:16px; box-shadow:0 2px 12px #0002; padding:30px; margin-bottom:30px;">
                    <h3 style="text-align:center; color:#1976d2; margin-bottom:20px;">Sunset Roadmap</h3>
                    
                    <!-- Onglets de r√©gions -->
                    <div style="display:flex; justify-content:center; gap:10px; margin-bottom:20px; flex-wrap:wrap;">
                        <button class="region-tab active" onclick="filterGanttByRegion('All')">All Regions</button>
                        <button class="region-tab" onclick="filterGanttByRegion('APAC')" style="--tab-color:#d32f2f;">APAC</button>
                        <button class="region-tab" onclick="filterGanttByRegion('EUROPE')" style="--tab-color:#1976d2;">EUROPE</button>
                        <button class="region-tab" onclick="filterGanttByRegion('Global')" style="--tab-color:#7b1fa2;">Global</button>
                        <button class="region-tab" onclick="filterGanttByRegion('LATAM')" style="--tab-color:#388e3c;">LATAM</button>
                        <button class="region-tab" onclick="filterGanttByRegion('NORTAM')" style="--tab-color:#f57c00;">NORTAM</button>
                    </div>
                    
                    <div id="customGanttChart"></div>
                </div>
            </div>
            
            <!-- View 3: Table -->
            <div id="view3" class="chart-view" style="display:none;">
                <div id="result"></div>
            </div>
            
            <!-- View 4: Replaced by visualization -->
            <div id="view4" class="chart-view" style="display:none;">
                <div style="background:#fff; border:1px solid #ddd; border-radius:16px; box-shadow:0 2px 12px #0002; padding:30px; margin-bottom:30px;">
                    <h3 style="text-align:center; color:#1976d2; margin-bottom:20px;">Replacement Applications Flow</h3>
                    
                    <!-- Onglets d'ann√©e -->
                    <div style="display:flex; justify-content:center; gap:10px; margin-bottom:20px; flex-wrap:wrap;">
                        <button class="year-tab active" onclick="filterReplacedByYear(2025)" style="padding:10px 20px; border:2px solid #1976d2; background:#1976d2; color:white; border-radius:8px; cursor:pointer; font-weight:bold; transition:all 0.3s;">2025</button>
                        <button class="year-tab" onclick="filterReplacedByYear(2026)" style="padding:10px 20px; border:2px solid #1976d2; background:white; color:#1976d2; border-radius:8px; cursor:pointer; font-weight:bold; transition:all 0.3s;">2026</button>
                        <button class="year-tab" onclick="filterReplacedByYear(2027)" style="padding:10px 20px; border:2px solid #1976d2; background:white; color:#1976d2; border-radius:8px; cursor:pointer; font-weight:bold; transition:all 0.3s;">2027</button>
                        <button class="year-tab" onclick="filterReplacedByYear(2028)" style="padding:10px 20px; border:2px solid #1976d2; background:white; color:#1976d2; border-radius:8px; cursor:pointer; font-weight:bold; transition:all 0.3s;">2028</button>
                    </div>
                    
                    <div id="replacedByChart" style="position:relative; min-height:600px; overflow:auto;"></div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let decommChart = null;
        let ganttChart = null;
        let currentRegionFilter = 'All';
        
        // Fonction pour changer de vue
        function showView(viewNumber) {
            // Cacher toutes les vues
            document.getElementById('view1').style.display = 'none';
            document.getElementById('view2').style.display = 'none';
            document.getElementById('view3').style.display = 'none';
            document.getElementById('view4').style.display = 'none';
            
            // Masquer le panneau de d√©tails du bar chart
            document.getElementById('bar-chart-details').style.display = 'none';
            
            // Retirer la classe active de tous les boutons
            document.querySelectorAll('.slider-btn').forEach(btn => btn.classList.remove('active'));
            
            // Afficher la vue s√©lectionn√©e
            document.getElementById('view' + viewNumber).style.display = 'block';
            document.getElementById('btnView' + viewNumber).classList.add('active');
            
            // Charger le graph "replaced by" si on affiche cette vue
            if (viewNumber === 4) {
                loadReplacedByChart(2025);
            }
        }
        
        // Fonction pour filtrer le Gantt par r√©gion
        function filterGanttByRegion(region) {
            currentRegionFilter = region;
            
            // Mettre √† jour les onglets actifs
            document.querySelectorAll('.region-tab').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Recharger le Gantt avec le filtre
            loadGanttChart(region);
        }
        
        // Fonction pour charger le summary
        function loadSummary() {
            fetch('Decomm.json').then(r => r.json()).then(apps => {
                const years = ['2025', '2026', '2027', '2028'];
                const summary = {};
                years.forEach(year => {
                    summary[year] = { retire: 0, replace: 0, tco: 0 };
                });
                apps.forEach(app => {
                    const year = app['7R_action_year'];
                    if (years.includes(year)) {
                        if (app['7R_analysis'] === 'Retire') summary[year].retire++;
                        else if (app['7R_analysis'] === 'Replace') summary[year].replace++;
                        if (app.tco) summary[year].tco += app.tco;
                    }
                });
                let html = '';
                years.forEach(year => {
                    html += `<tr>`;
                    html += `<td style="padding:8px 6px; text-align:center; font-weight:bold; color:#1976d2;">${year}</td>`;
                    html += `<td style="padding:8px 6px; text-align:center; color:#d32f2f; font-weight:bold;">${summary[year].retire}</td>`;
                    html += `<td style="padding:8px 6px; text-align:center; color:#388e3c; font-weight:bold;">${summary[year].replace}</td>`;
                    html += `<td style="padding:8px 6px; text-align:center; color:#7b1fa2; font-weight:bold;">$${summary[year].tco.toLocaleString('fr-FR', {maximumFractionDigits: 0})}</td>`;
                    html += `</tr>`;
                });
                document.getElementById('year-summary-tbody').innerHTML = html;
            }).catch(err => {
                console.error('Erreur lors du chargement du summary:', err);
            });
        }
        
        // Fonction pour charger le graphique "Replaced by"
        function loadReplacedByChart(yearFilter = 'All') {
            fetch('Decomm.json').then(r => r.json()).then(apps => {
                // Filtrer les applications qui ont un replace_by
                let appsWithReplacement = apps.filter(app => app.replace_by && app.replace_by.trim() !== '');
                
                // Filtrer par ann√©e si sp√©cifi√©
                if (yearFilter !== 'All') {
                    appsWithReplacement = appsWithReplacement.filter(app => app['7R_action_year'] == yearFilter);
                }
                
                // Grouper par replace_by et calculer TCO total
                const replacementGroups = {};
                appsWithReplacement.forEach(app => {
                    const replaceBy = app.replace_by;
                    if (!replacementGroups[replaceBy]) {
                        replacementGroups[replaceBy] = {
                            name: replaceBy,
                            apps: [],
                            totalTco: 0
                        };
                    }
                    replacementGroups[replaceBy].apps.push(app);
                    replacementGroups[replaceBy].totalTco += (app.tco || 0);
                });
                
                // Convertir en tableau et trier par TCO
                const replacements = Object.values(replacementGroups).sort((a, b) => b.totalTco - a.totalTco);
                
                // Calculer le maxTco apr√®s le filtrage
                const maxTco = replacements.length > 0 ? replacements[0].totalTco : 1;
                
                // Cr√©er la visualisation
                const container = document.getElementById('replacedByChart');
                let html = '<svg width="100%" height="' + (replacements.length * 150 + 150) + '" style="position:absolute; top:0; left:0; pointer-events:none;" id="arrowsSvg"></svg>';
                html += '<div style="position:relative; padding-top:50px;">';
                
                // Pour chaque solution de remplacement
                replacements.forEach((replacement, index) => {
                    const yPos = index * 150 + 50;
                    
                    // Calculer la taille de la bulle (min 60, max 150) proportionnelle au TCO
                    const minSize = 60;
                    const maxSize = 150;
                    const bubbleSize = minSize + (replacement.totalTco / maxTco) * (maxSize - minSize);
                    
                    html += `<div style="position:absolute; left:50%; top:${yPos}px; transform:translateX(-50%); display:flex; align-items:center; gap:20px;">`;
                    
                    // Bulle de la solution de remplacement
                    html += `<div style="width:${bubbleSize}px; height:${bubbleSize}px; border-radius:50%; background:linear-gradient(135deg, #1976d2, #42a5f5); display:flex; align-items:center; justify-content:center; color:white; font-weight:bold; text-align:center; padding:10px; box-shadow:0 4px 12px rgba(25,118,210,0.4);">`;
                    html += `<div style="font-size:${Math.max(10, bubbleSize/8)}px;">${replacement.name}</div>`;
                    html += `</div>`;
                    
                    // TCO et nombre d'apps √† droite
                    html += `<div style="font-size:12px; color:#666;">`;
                    if (replacement.totalTco > 0) {
                        html += `<div style="font-weight:bold; color:#1976d2; font-size:16px;">‚Ç¨${replacement.totalTco.toLocaleString('fr-FR', {maximumFractionDigits:0})}</div>`;
                    }
                    html += `<div>${replacement.apps.length} app(s)</div>`;
                    html += `</div>`;
                    
                    html += `</div>`;
                    
                    // Applications sources √† gauche
                    const appsPerColumn = Math.ceil(replacement.apps.length / 2);
                    replacement.apps.forEach((app, appIndex) => {
                        const column = Math.floor(appIndex / appsPerColumn);
                        const row = appIndex % appsPerColumn;
                        const xPos = column * 250 + 50;
                        const appYPos = yPos + row * 35 - (appsPerColumn * 35) / 2 + 20;
                        
                        const regionColors = {
                            'APAC': '#d32f2f',
                            'EUROPE': '#1976d2',
                            'Global': '#7b1fa2',
                            'LATAM': '#388e3c',
                            'NORTAM': '#f57c00'
                        };
                        
                        html += `<div class="source-app" data-replacement-index="${index}" data-app-index="${appIndex}" style="position:absolute; left:${xPos}px; top:${appYPos}px; background:#f5f5f5; padding:8px 12px; border-radius:6px; border-left:4px solid ${regionColors[app.region] || '#999'}; font-size:11px; max-width:200px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; box-shadow:0 2px 4px rgba(0,0,0,0.1);" title="${app.name}">`;
                        html += app.name.length > 20 ? app.name.substring(0, 20) + '...' : app.name;
                        html += `</div>`;
                    });
                });
                
                html += '</div>';
                container.innerHTML = html;
                
                // Dessiner les fl√®ches avec SVG
                setTimeout(() => {
                    const svg = document.getElementById('arrowsSvg');
                    let svgContent = '';
                    
                    document.querySelectorAll('.source-app').forEach(appDiv => {
                        const replacementIndex = parseInt(appDiv.getAttribute('data-replacement-index'));
                        const replacement = replacements[replacementIndex];
                        const yPos = replacementIndex * 150 + 50;
                        
                        const rect = appDiv.getBoundingClientRect();
                        const containerRect = container.getBoundingClientRect();
                        
                        const x1 = rect.right - containerRect.left;
                        const y1 = rect.top - containerRect.top + rect.height / 2;
                        const x2 = container.offsetWidth / 2 - 80;
                        const y2 = yPos + 20;
                        
                        // Ligne courbe (quadratic bezier)
                        const controlX = (x1 + x2) / 2;
                        const controlY = y1;
                        
                        svgContent += `<path d="M ${x1} ${y1} Q ${controlX} ${controlY} ${x2} ${y2}" stroke="#1976d2" stroke-width="1.5" fill="none" opacity="0.4" marker-end="url(#arrowhead)"/>`;
                    });
                    
                    // D√©finir le marker pour les fl√®ches
                    svg.innerHTML = `<defs><marker id="arrowhead" markerWidth="10" markerHeight="10" refX="8" refY="3" orient="auto"><polygon points="0 0, 10 3, 0 6" fill="#1976d2" opacity="0.6"/></marker></defs>` + svgContent;
                }, 100);
                
            }).catch(err => {
                console.error('Erreur lors du chargement du graphique Replaced by:', err);
            });
        }
        
        // Ajout d'un spinner de chargement dans le container
function showReplacedByLoading() {
    const container = document.getElementById('replacedByChart');
    container.innerHTML = '<div id="replacedByLoading" style="display:flex;justify-content:center;align-items:center;height:300px;"><div class="spinner" style="border:6px solid #eee;border-top:6px solid #1976d2;border-radius:50%;width:48px;height:48px;animation:spin 1s linear infinite;"></div></div>';
}

// Ajout du CSS pour le spinner
const style = document.createElement('style');
style.innerHTML = `@keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }`;
document.head.appendChild(style);

// Fonction pour filtrer Replaced by par ann√©e
function filterReplacedByYear(year) {
    // Mettre √† jour les styles des onglets
    document.querySelectorAll('.year-tab').forEach(tab => {
        tab.style.background = 'white';
        tab.style.color = '#1976d2';
    });
    event.target.style.background = '#1976d2';
    event.target.style.color = 'white';
    // Afficher le spinner
    showReplacedByLoading();
    // Recharger le graphique avec un petit d√©lai pour laisser le spinner s'afficher
    setTimeout(() => loadReplacedByChart(year), 250);
}
        
        // Charger les donn√©es
        document.addEventListener('DOMContentLoaded', function() {
            loadSummary();
            loadDecommissioningData();
            loadChartData();
            loadGanttChart('All');
            
            // Ajouter l'√©v√©nement de filtre
            document.getElementById('analysis-filter').addEventListener('change', function() {
                loadDecommissioningData(this.value);
            });
        });
        
        // Fonction pour charger et afficher le bar chart
        function loadChartData() {
            fetch('Decomm.json').then(r => r.json()).then(apps => {
                const years = ['2025', '2026', '2027', '2028'];
                // Agr√©ger les donn√©es par ann√©e et cat√©gorie (toutes r√©gions confondues)
                const aggregated = {};
                years.forEach(year => {
                    aggregated[year] = {
                        'Retire': 0,
                        'Replace': 0,
                        'In production to be replaced': 0
                    };
                });
                apps.forEach(app => {
                    const year = app['7R_action_year'];
                    const analysis = app['7R_analysis'];
                    if (year && analysis && aggregated[year]) {
                        if (analysis === 'Retire') {
                            aggregated[year]['Retire'] += 1;
                        } else if (analysis === 'Replace') {
                            aggregated[year]['Replace'] += 1;
                        } else if (analysis === 'In production to be replaced') {
                            aggregated[year]['In production to be replaced'] += 1;
                        }
                    }
                });
                // Cr√©er trois datasets : Retire, Replace (stacked pour Retired), et In Production
                const datasets = [
                    {
                        label: 'Retire',
                        data: years.map(year => aggregated[year]['Retire']),
                        backgroundColor: '#1976d2',
                        borderColor: '#1976d2',
                        borderWidth: 1,
                        stack: 'Retired',
                        categoryType: 'Retired'
                    },
                    {
                        label: 'Replace',
                        data: years.map(year => aggregated[year]['Replace']),
                        backgroundColor: '#42a5f5',
                        borderColor: '#42a5f5',
                        borderWidth: 1,
                        stack: 'Retired',
                        categoryType: 'Retired'
                    },
                    {
                        label: 'In Production',
                        data: years.map(year => aggregated[year]['In production to be replaced']),
                        backgroundColor: '#7b1fa2',
                        borderColor: '#7b1fa2',
                        borderWidth: 1,
                        stack: 'In Production',
                        categoryType: 'In Production'
                    }
                ];
                const ctx = document.getElementById('decommChart').getContext('2d');
                if (decommChart) {
                    decommChart.destroy();
                }
                decommChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: years,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        onClick: function(event, activeElements) {
                            if (activeElements.length > 0) {
                                const clickedElement = activeElements[0];
                                const datasetIndex = clickedElement.datasetIndex;
                                const dataIndex = clickedElement.index;
                                const dataset = datasets[datasetIndex];
                                const year = years[dataIndex];
                                const label = dataset.label;
                                // D√©terminer la cat√©gorie √† filtrer
                                let matchCategory = null;
                                if (label === 'Retire') matchCategory = 'Retire';
                                else if (label === 'Replace') matchCategory = 'Replace';
                                else if (label === 'In Production') matchCategory = 'In production to be replaced';
                                // Filtrer les applications correspondantes
                                const filteredApps = apps.filter(app => {
                                    return app['7R_action_year'] === year && app['7R_analysis'] === matchCategory;
                                });
                                // Afficher les d√©tails
                                const detailsDiv = document.getElementById('bar-chart-details');
                                const detailsContent = document.getElementById('bar-chart-details-content');
                                if (filteredApps.length > 0) {
                                    detailsDiv.style.display = 'block';
                                    let html = `<h4 style=\"margin-top:0; color:#1976d2;\">${label} (${year})</h4>`;
                                    html += `<p style=\"margin-bottom:15px; color:#666;\">${filteredApps.length} application(s)</p>`;
                                    html += '<div style=\"display:grid; grid-template-columns:repeat(auto-fill, minmax(300px, 1fr)); gap:15px;\">';
                                    filteredApps.forEach(app => {
                                        html += '<div style=\"background:#fff; padding:12px; border-radius:6px; border-left:4px solid #1976d2;\">';
                                        html += `<div style=\"font-weight:bold; margin-bottom:8px; color:#333;\">${app.name}</div>`;
                                        html += `<div style=\"font-size:0.9em; color:#888; margin-bottom:4px;\">üåç ${app.region || ''}</div>`;
                                        if (app['7R_action_month']) {
                                            const monthNames = ['', 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sept', 'Oct', 'Nov', 'Dec'];
                                            const monthToNumber = {'jan': 1, 'feb': 2, 'mar': 3, 'apr': 4, 'may': 5, 'jun': 6, 'jul': 7, 'aug': 8, 'sept': 9, 'oct': 10, 'nov': 11, 'dec': 12};
                                            const monthNum = monthToNumber[app['7R_action_month']];
                                            html += `<div style=\"font-size:0.9em; color:#666; margin-bottom:4px;\">üìÖ ${monthNames[monthNum]} ${year}</div>`;
                                        }
                                        if (app.tco) {
                                            html += `<div style=\"font-size:0.9em; color:#666; margin-bottom:4px;\">üí∞ TCO: $${app.tco.toLocaleString('fr-FR')}</div>`;
                                        }
                                        if (app.replace_by) {
                                            html += `<div style=\"font-size:0.9em; color:#666;\">üîÑ Replace by: ${app.replace_by}</div>`;
                                        }
                                        html += '</div>';
                                    });
                                    html += '</div>';
                                    detailsContent.innerHTML = html;
                                    // Scroll vers les d√©tails avec un offset pour voir le titre
                                    requestAnimationFrame(() => {
                                        const rect = detailsDiv.getBoundingClientRect();
                                        const offset = 100; // Offset pour laisser de l'espace au-dessus du titre
                                        const absoluteY = window.scrollY + rect.top - offset;
                                        window.scrollTo({ top: absoluteY, behavior: 'smooth' });
                                    });
                                } else {
                                    detailsDiv.style.display = 'none';
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    font: {
                                        size: 12
                                    },
                                    padding: 10,
                                    filter: function(legendItem, chartData) {
                                        // Afficher seulement le premier dataset de chaque r√©gion
                                        const dataset = chartData.datasets[legendItem.datasetIndex];
                                        return dataset.categoryType === 'Retire';
                                    },
                                    generateLabels: function(chart) {
                                        const datasets = chart.data.datasets;
                                        const regionsSeen = new Set();
                                        const labels = [];
                                        datasets.forEach((dataset, i) => {
                                            if (dataset.categoryType === 'Retire' && !regionsSeen.has(dataset.regionName)) {
                                                regionsSeen.add(dataset.regionName);
                                                labels.push({
                                                    text: dataset.regionName,
                                                    fillStyle: dataset.backgroundColor,
                                                    strokeStyle: dataset.borderColor,
                                                    lineWidth: dataset.borderWidth,
                                                    hidden: false,
                                                    datasetIndex: i
                                                });
                                            }
                                        });
                                        return labels;
                                    }
                                }
                            },
                            title: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': ' + context.parsed.y + ' app(s)';
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                stacked: true,
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    font: {
                                        size: 14
                                    }
                                }
                            },
                            y: {
                                stacked: true,
                                beginAtZero: true,
                                ticks: {
                                    font: {
                                        size: 14
                                    },
                                    callback: function(value) {
                                        return value + ' app(s)';
                                    }
                                },
                                title: {
                                    display: true,
                                    text: 'Number of Applications',
                                    font: {
                                        size: 14
                                    }
                                }
                            }
                        }
                    }
                });
            }).catch(err => {
                console.error('Erreur lors du chargement du chart:', err);
            });
        }
        
        // Fonction pour charger et afficher le Gantt chart personnalis√©
        function loadGanttChart(regionFilter = 'All') {
            fetch('Decomm.json').then(r => r.json()).then(apps => {
                // Filtrer par ann√©e et par r√©gion
                let filteredApps = apps.filter(app => app['7R_action_year']);
                
                // Appliquer le filtre de r√©gion
                if (regionFilter !== 'All') {
                    filteredApps = filteredApps.filter(app => app.region === regionFilter);
                }
                
                // Trier par ann√©e puis par nom
                filteredApps.sort((a, b) => {
                    const yearA = parseInt(a['7R_action_year']) || 9999;
                    const yearB = parseInt(b['7R_action_year']) || 9999;
                    if (yearA !== yearB) return yearA - yearB;
                    return (a.name || '').localeCompare(b.name || '');
                });
                
                const regionColors = {
                    'APAC': '#d32f2f',
                    'EUROPE': '#1976d2',
                    'Global': '#7b1fa2',
                    'LATAM': '#388e3c',
                    'NORTAM': '#f57c00'
                };
                
                // Cr√©er le Gantt HTML personnalis√©
                let html = '<div style="overflow-x: auto;">';
                
                // En-t√™te avec les ann√©es
                html += '<div style="display: flex; margin-bottom: 10px; padding-left: 250px;">';
                html += '<div style="flex: 1; text-align: center; font-weight: bold; border-left: 2px solid #ddd; padding: 10px;">2025</div>';
                html += '<div style="flex: 1; text-align: center; font-weight: bold; border-left: 2px solid #ddd; padding: 10px;">2026</div>';
                html += '<div style="flex: 1; text-align: center; font-weight: bold; border-left: 2px solid #ddd; padding: 10px;">2027</div>';
                html += '<div style="flex: 1; text-align: center; font-weight: bold; border-left: 2px solid #ddd; padding: 10px;">2028</div>';
                html += '<div style="width: 2px; background: #ddd;"></div>';
                html += '</div>';
                
                // Conversion des mois en num√©ros
                const monthToNumber = {
                    'jan': 1, 'feb': 2, 'mar': 3, 'apr': 4, 'may': 5, 'jun': 6,
                    'jul': 7, 'aug': 8, 'sept': 9, 'oct': 10, 'nov': 11, 'dec': 12
                };
                
                // Trier par ann√©e, puis par mois, puis par nom
                filteredApps.sort((a, b) => {
                    const yearA = parseInt(a['7R_action_year']) || 9999;
                    const yearB = parseInt(b['7R_action_year']) || 9999;
                    if (yearA !== yearB) return yearA - yearB;
                    const monthToNumber = {
                        'jan': 1, 'feb': 2, 'mar': 3, 'apr': 4, 'may': 5, 'jun': 6,
                        'jul': 7, 'aug': 8, 'sept': 9, 'oct': 10, 'nov': 11, 'dec': 12
                    };
                    const monthA = a['7R_action_month'] ? monthToNumber[a['7R_action_month']] : 12;
                    const monthB = b['7R_action_month'] ? monthToNumber[b['7R_action_month']] : 12;
                    if (monthA !== monthB) return monthA - monthB;
                    return (a.name || '').localeCompare(b.name || '');
                });

                // Lignes des applications
                filteredApps.forEach(app => {
                    const year = parseInt(app['7R_action_year']);
                    const month = app['7R_action_month'] ? monthToNumber[app['7R_action_month']] : 12; // Par d√©faut d√©cembre si pas de mois
                    const startYear = 2025;
                    const startMonth = 1; // Janvier 2025
                    const color = regionColors[app.region] || '#999';
                    // Calculer la date de fin en mois depuis janvier 2025
                    const startMonthTotal = (startYear - 2025) * 12 + startMonth;
                    const endMonthTotal = (year - 2025) * 12 + month;
                    // Calculer la position et la largeur de la barre
                    const totalMonths = 4 * 12; // 2025-2028 = 48 mois
                    const startPos = ((startMonthTotal - 1) / totalMonths) * 100;
                    const width = ((endMonthTotal - startMonthTotal + 1) / totalMonths) * 100;
                    html += '<div style="display: flex; align-items: center; min-height: 35px; border-bottom: 1px solid #f0f0f0;">';
                    // Nom de l'application (fixe √† gauche)
                    const appName = app.name.length > 30 ? app.name.substring(0, 30) + '...' : app.name;
                    html += `<div style="width: 250px; padding: 5px 10px; font-size: 12px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${app.name}">${appName}</div>`;
                    // Zone de la timeline
                    html += '<div style="flex: 1; position: relative; height: 25px; background: linear-gradient(to right, transparent 0%, transparent 25%, transparent 25%, transparent 50%, transparent 50%, transparent 75%, transparent 75%, transparent 100%); border-left: 2px solid #ddd;">';
                    // Grille verticale
                    html += '<div style="position: absolute; left: 25%; top: 0; bottom: 0; width: 2px; background: #ddd;"></div>';
                    html += '<div style="position: absolute; left: 50%; top: 0; bottom: 0; width: 2px; background: #ddd;"></div>';
                    html += '<div style="position: absolute; left: 75%; top: 0; bottom: 0; width: 2px; background: #ddd;"></div>';
                    html += '<div style="position: absolute; right: 0; top: 0; bottom: 0; width: 2px; background: #ddd;"></div>';
                    // Barre de progression
                    const barWidth = width < 1 ? 1 : width; // Largeur minimale pour visibilit√©
                    const monthNames = ['', 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sept', 'Oct', 'Nov', 'Dec'];
                    const monthDisplay = app['7R_action_month'] ? monthNames[month] : '';
                    html += `<div style="position: absolute; left: ${startPos}%; width: ${barWidth}%; height: 18px; top: 3px; background: ${color}; border-radius: 3px; cursor: pointer;" 
                        title="App: ${app.name}&#10;Year: ${app['7R_action_year']}${monthDisplay ? '&#10;Month: ' + monthDisplay : ''}&#10;Region: ${app.region}&#10;7R: ${app['7R_analysis']}&#10;TCO: ‚Ç¨${app.tco ? app.tco.toLocaleString('fr-FR') : 'N/A'}"></div>`;
                    html += '</div>';
                    html += '</div>';
                });
                
                html += '</div>';
                
                document.getElementById('customGanttChart').innerHTML = html;
            }).catch(err => {
                console.error('Erreur lors du chargement du Gantt:', err);
            });
        }
        
        function loadDecommissioningData(filter = '') {
            fetch('Decomm.json').then(r => r.json()).then(apps => {
                // Appliquer le filtre si s√©lectionn√©
                let filteredApps = apps;
                if (filter) {
                    filteredApps = apps.filter(app => app["7R_analysis"] === filter);
                }
                
                // Trier par 7R_action_year puis par nom
                filteredApps.sort((a, b) => {
                    const yearA = parseInt(a["7R_action_year"]) || 9999;
                    const yearB = parseInt(b["7R_action_year"]) || 9999;
                    if (yearA !== yearB) return yearA - yearB;
                    return (a.name || '').localeCompare(b.name || '');
                });
                
                // G√©n√©rer le tableau
                let html = '<div class="comparison-table"><div class="table-header">';
                html += '<h3>Decommissioning Plan</h3>';
                html += '</div>';
                html += '<table class="capability-table"><thead><tr>';
                html += '<th>Application</th>';
                html += '<th>Application Code</th>';
                html += '<th>Region</th>';
                html += '<th>Category</th>';
                html += '<th>7R Analysis</th>';
                html += '<th>Action Year</th>';
                html += '<th>Replace By</th>';
                html += '<th>TCO (‚Ç¨)</th>';
                html += '</tr></thead><tbody>';
                
                // Grouper par ann√©e
                let currentYear = null;
                filteredApps.forEach(app => {
                    const year = app["7R_action_year"] || 'Not Planned';
                    
                    // Ajouter une ligne de s√©paration pour chaque nouvelle ann√©e
                    if (year !== currentYear) {
                        currentYear = year;
                        html += `<tr class="l1-row"><td colspan="8" style="font-size:1.2em;"><b>Year: ${year}</b></td></tr>`;
                    }
                    
                    // Ligne de l'application
                    html += '<tr class="l2-row">';
                    html += `<td style="font-weight:bold;">${app.name || ''}</td>`;
                    html += `<td>${app.application_code || ''}</td>`;
                    html += `<td>${app.region || ''}</td>`;
                    html += `<td>${app.category || ''}</td>`;
                    html += `<td style="text-align:center;">${app["7R_analysis"] || ''}</td>`;
                    html += `<td style="text-align:center;">${app["7R_action_year"] || ''}</td>`;
                    html += `<td>${app.replace_by || ''}</td>`;
                    html += `<td style="text-align:right;">${app.tco ? app.tco.toLocaleString() : ''}</td>`;
                    html += '</tr>';
                });
                
                html += '</tbody></table></div>';
                
                document.getElementById('result').innerHTML = html;
            }).catch(err => {
                console.error('Erreur lors du chargement des donn√©es:', err);
                document.getElementById('result').innerHTML = '<div class="comparison-table"><div class="table-header"><h3>Erreur de chargement</h3></div></div>';
            });
        }
    </script>
</body>
</html>
