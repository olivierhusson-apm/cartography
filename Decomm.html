<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1280">
    <title>Decommissioning Plan</title>
    <link rel="stylesheet" href="Decomm-styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
</head>
<body>
    <div id="banner">
        <img src="CEVA_BlueRed.jpg" alt="CEVA Logistics" id="banner-logo">
        <h1>Decommissioning Planning Tool</h1>
    </div>
    
    <div class="container">
        <div style="margin-bottom:10px;">
            <button class="back-button" onclick="window.close()">‚Üê Back</button>
        </div>
        
        <div class="comparison-area">
            <div id="summary-section" style="background:#f8f9fa; border:2px solid #1976d2; border-radius:12px; padding:20px; margin-bottom:30px;">
                <h3 style="text-align:center; color:#1976d2; margin-top:0; margin-bottom:20px;">Decommissioning Overview</h3>
                <div id="year-summary-table" style="overflow-x:auto;">
                    <table style="width:100%; border-collapse:collapse; background:#fff; font-size:1.3em;">
                        <thead>
                            <tr style="background:#f0f4fa; color:#1976d2;">
                                <th style="padding:14px 10px; border-bottom:3px solid #1976d2; font-size:1em;">Year</th>
                                <th style="padding:14px 10px; border-bottom:3px solid #1976d2; font-size:1em;">Retire</th>
                                <th style="padding:14px 10px; border-bottom:3px solid #1976d2; font-size:1em;">Replace</th>
                                <th style="padding:14px 10px; border-bottom:3px solid #1976d2; font-size:1em;">TCO ($)</th>
                            </tr>
                        </thead>
                        <tbody id="year-summary-tbody"></tbody>
                    </table>
                </div>
            </div>
            
            <div id="view1" class="chart-view">
                <div style="background:#fff; border:1px solid #ddd; border-radius:16px; box-shadow:0 2px 12px #0002; padding:30px; margin-bottom:30px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                        <h3 id="chart-title" style="text-align:center; color:#1976d2; flex:1; margin:0;">Decommissioning Plan</h3>
                        <button id="back-to-yearly-btn" onclick="backToYearlyView()" style="display:none; padding:10px 20px; background:#1976d2; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">‚Üê Back to Yearly View</button>
                    </div>
                    
                    <div style="display:flex; justify-content:center; gap:10px; margin-bottom:20px; flex-wrap:wrap;">
                        <button class="region-filter-tab active" onclick="filterChartByRegion('All')" style="padding:10px 20px; border:2px solid #1976d2; background:#1976d2; color:white; border-radius:8px; cursor:pointer; font-weight:bold; transition:all 0.3s;">All Regions</button>
                        <button class="region-filter-tab" onclick="filterChartByRegion('APAC')" style="padding:10px 20px; border:2px solid #d32f2f; background:white; color:#d32f2f; border-radius:8px; cursor:pointer; font-weight:bold; transition:all 0.3s;">APAC</button>
                        <button class="region-filter-tab" onclick="filterChartByRegion('EUROPE')" style="padding:10px 20px; border:2px solid #1976d2; background:white; color:#1976d2; border-radius:8px; cursor:pointer; font-weight:bold; transition:all 0.3s;">EUROPE</button>
                        <button class="region-filter-tab" onclick="filterChartByRegion('IMECA')" style="padding:10px 20px; border:2px solid #7b1fa2; background:white; color:#7b1fa2; border-radius:8px; cursor:pointer; font-weight:bold; transition:all 0.3s;">IMECA</button>
                        <button class="region-filter-tab" onclick="filterChartByRegion('LATAM')" style="padding:10px 20px; border:2px solid #388e3c; background:white; color:#388e3c; border-radius:8px; cursor:pointer; font-weight:bold; transition:all 0.3s;">LATAM</button>
                        <button class="region-filter-tab" onclick="filterChartByRegion('NORTAM')" style="padding:10px 20px; border:2px solid #f57c00; background:white; color:#f57c00; border-radius:8px; cursor:pointer; font-weight:bold; transition:all 0.3s;">NORTAM</button>
                        <button class="region-filter-tab" onclick="filterChartByRegion('GHO')" style="padding:10px 20px; border:2px solid #795548; background:white; color:#795548; border-radius:8px; cursor:pointer; font-weight:bold; transition:all 0.3s;">GHO</button>
                    </div>
                    
                    <div style="display:flex; justify-content:center; gap:10px; margin-bottom:20px; flex-wrap:wrap;">
                        <button class="year-filter-tab" onclick="filterChartByYear('2025')" style="padding:10px 20px; border:2px solid #1976d2; background:white; color:#1976d2; border-radius:8px; cursor:pointer; font-weight:bold; transition:all 0.3s;">2025</button>
                        <button class="year-filter-tab" onclick="filterChartByYear('2026')" style="padding:10px 20px; border:2px solid #1976d2; background:white; color:#1976d2; border-radius:8px; cursor:pointer; font-weight:bold; transition:all 0.3s;">2026</button>
                        <button class="year-filter-tab" onclick="filterChartByYear('2027')" style="padding:10px 20px; border:2px solid #1976d2; background:white; color:#1976d2; border-radius:8px; cursor:pointer; font-weight:bold; transition:all 0.3s;">2027</button>
                        <button class="year-filter-tab" onclick="filterChartByYear('2028')" style="padding:10px 20px; border:2px solid #1976d2; background:white; color:#1976d2; border-radius:8px; cursor:pointer; font-weight:bold; transition:all 0.3s;">2028</button>
                    </div>
                    
                    <canvas id="decommChart" width="800" height="400"></canvas>
                    
                    <div id="year-drill-buttons" style="display:none; justify-content:center; gap:15px; margin-top:20px;">
                        <button onclick="drillDownToYear('2025')" style="padding:12px 24px; background:#1976d2; color:white; border:2px solid #1976d2; border-radius:8px; cursor:pointer; font-weight:bold; font-size:16px; transition:all 0.3s;">
                            2025 üìä
                        </button>
                        <button onclick="drillDownToYear('2026')" style="padding:12px 24px; background:#1976d2; color:white; border:2px solid #1976d2; border-radius:8px; cursor:pointer; font-weight:bold; font-size:16px; transition:all 0.3s;">
                            2026 üìä
                        </button>
                        <button onclick="drillDownToYear('2027')" style="padding:12px 24px; background:#1976d2; color:white; border:2px solid #1976d2; border-radius:8px; cursor:pointer; font-weight:bold; font-size:16px; transition:all 0.3s;">
                            2027 üìä
                        </button>
                        <button onclick="drillDownToYear('2028')" style="padding:12px 24px; background:#1976d2; color:white; border:2px solid #1976d2; border-radius:8px; cursor:pointer; font-weight:bold; font-size:16px; transition:all 0.3s;">
                            2028 üìä
                        </button>
                    </div>
                </div>
                
                <div style="text-align:center; margin-top:30px;">
                    <button id="export-excel-btn" style="padding:12px 30px; background:#43a047; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold; font-size:16px; box-shadow:0 2px 8px rgba(67,160,71,0.3); transition:all 0.3s;" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 12px rgba(67,160,71,0.4)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(67,160,71,0.3)';">üìä Export to Excel</button>
                </div>
            </div>
            
            <div id="bar-chart-details" style="display:none; margin-top:20px; padding:20px; background:#f5f5f5; border-radius:8px;">
                <div id="bar-chart-details-content"></div>
            </div>
            

            

            

        </div>
    </div>
    
    <script>
        let decommChart = null;
        let currentRegionFilter = 'All';
        let currentView = 'yearly'; // 'yearly' ou 'quarterly'
        let currentYear = null;
        
        // Table de correspondance IT Owner -> IT Owner Region
        const itOwnerToRegion = {
            'PEREIRA BRUNO': 'LATAM',
            'DEBERT, Julien': 'EUROPE',
            'BIERNACKI Scott': 'NORTAM',
            'RAUCH, Nancy, DEBERT, Julien': 'EUROPE',
            'DEBERT, Julien, Santoni Paolo': 'EUROPE',
            'Santoni Paolo': 'EUROPE',
            'BERNICOT, Marc': 'GHO',
            'Santoni Paolo, DEBERT, Julien, Rubini, Marco': 'EUROPE',
            'Habara Rudy': 'NORTAM',
            'Santoni Paolo, DEBERT, Julien, Seemann, Marco': 'EUROPE',
            'Agir Dilek, RAUCH, Nancy, DEBERT, Julien': 'EUROPE',
            'Cano Adolfo, Santoni Paolo, DEBERT, Julien': 'EUROPE',
            'VERRECCHIA, Matthieu, DEBERT, Julien': 'EUROPE',
            'Kelly Shawn': 'NORTAM',
            'POUYE Fatou, RAUCH, Nancy, DEBERT, Julien': 'EUROPE',
            'Agir Dilek, Santoni Paolo, DEBERT, Julien': 'EUROPE',
            'Rubini, Marco, Santoni Paolo, DEBERT, Julien': 'EUROPE',
            'Santoni Paolo, DEBERT, Julien, Agir Dilek': 'EUROPE',
            'Rogers, Jeff (Houston)': 'NORTAM',
            'VERRECCHIA, Matthieu': 'EUROPE',
            'Bayram, Kaan': 'EUROPE',
            'Kamal, Mohammed Maher': 'IMECA',
            'DEBERT, Julien, RAUCH, Nancy': 'EUROPE',
            'Pereira, Alex': 'LATAM',
            'Ramasamy Velu': 'APAC',
            'Seemann, Marco, Santoni Paolo, DEBERT, Julien': 'EUROPE',
            'Muro, Juan Manuel': 'GHO',
            'Wang, Bo': 'APAC',
            'Agir Dilek': 'EUROPE',
            'Santoni Paolo, DEBERT, Julien': 'EUROPE',
            'Garcia Leiser': 'NORTAM',
            'WENDLING, Patrice': 'EUROPE',
            'DEBERT, Julien, RAUCH, Nancy, PAPIN Anne': 'EUROPE',
            'Kopara Stacey': 'APAC',
            'DERRE Gael': 'GHO',
            'Heilmann Pat': 'NORTAM',
            'Pasmanik Gena': 'NORTAM',
            'PENEAUD Cyril (ADM)': 'EUROPE',
            'Yusuf Koc': 'EUROPE',
            'Yousef, Yousef Kamal': 'IMECA',
            'Rodriguez, Guillermo Gomez, Santoni Paolo, DEBERT, Julien': 'EUROPE',
            'RAUCH, Nancy, DEBERT, Julien, Forget Paul': 'EUROPE',
            'BIHR, Gerald': 'GHO',
            'POUYE Fatou, DEBERT, Julien, RAUCH, Nancy': 'EUROPE',
            'Gatiganti Ram': 'NORTAM',
            'Saruva, Sundaramoorthy': 'APAC',
            'RAUCH, Nancy': 'EUROPE',
            'Hossen Sayeed': 'IMECA',
            'Li Ye': 'NORTAM',
            'Seemann, Marco': 'EUROPE',
            'Laat Angelo de': 'GHO',
            'van Doornmalen Alois': 'EUROPE',
            'RAUCH Nancy, DEBERT, Julien': 'EUROPE',
            'Rubini, MarcoSantoni PaoloDEBERT, Julien': 'EUROPE'
        };
        
        // Fonction pour obtenir la r√©gion IT Owner d'une application
        function getITOwnerRegion(itOwner) {
            if (!itOwner) return null;
            return itOwnerToRegion[itOwner] || null;
        }
        
        function showView(viewNumber) {
            document.getElementById('view1').style.display = 'none';
            document.getElementById('bar-chart-details').style.display = 'none';
            document.querySelectorAll('.slider-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('view' + viewNumber).style.display = 'block';
            document.getElementById('btnView' + viewNumber).classList.add('active');
        }
        
        function filterChartByRegion(region) {
            currentRegionFilter = region;
            document.querySelectorAll('.region-filter-tab').forEach(btn => {
                btn.style.background = 'white';
                const borderColor = btn.style.borderColor;
                btn.style.color = borderColor;
            });
            if(event) {
                event.target.style.background = event.target.style.borderColor;
                event.target.style.color = 'white';
            }
            if (currentView === 'yearly') {
                loadChartData(region);
            } else {
                loadQuarterlyChartData(currentYear, region);
            }
        }
        
        function backToYearlyView() {
            currentView = 'yearly';
            currentYear = null;
            document.getElementById('back-to-yearly-btn').style.display = 'none';
            document.getElementById('chart-title').textContent = 'Decommissioning Plan by Year (2025-2028)';
            
            // D√©sactiver tous les boutons ann√©es
            document.querySelectorAll('.year-filter-tab').forEach(btn => {
                btn.style.background = 'white';
                btn.style.color = '#1976d2';
            });
            
            loadChartData(currentRegionFilter);
        }
        
        function filterChartByYear(year) {
            document.querySelectorAll('.year-filter-tab').forEach(btn => {
                btn.style.background = 'white';
                btn.style.color = '#1976d2';
            });
            if(event) {
                event.target.style.background = '#1976d2';
                event.target.style.color = 'white';
            }
            
            currentView = 'quarterly';
            currentYear = year;
            document.getElementById('chart-title').textContent = `Decommissioning Plan - ${year} by Quarter`;
            document.getElementById('back-to-yearly-btn').style.display = 'block';
            loadQuarterlyChartData(year, currentRegionFilter);
        }
        
        function drillDownToYear(year) {
            currentView = 'quarterly';
            currentYear = year;
            document.getElementById('chart-title').textContent = `Decommissioning Plan - ${year} by Quarter`;
            document.getElementById('back-to-yearly-btn').style.display = 'block';
            document.getElementById('year-drill-buttons').style.display = 'none';
            loadQuarterlyChartData(year, currentRegionFilter);
        }
        
        function loadQuarterlyChartData(year, regionFilter = 'All') {
            fetch('data.json').then(r => r.json()).then(apps => {
                let filteredApps = apps;
                // Exclure Matrix (car c'est la fusion de ses variantes)
                filteredApps = filteredApps.filter(app => app.name !== 'Matrix');
                
                if (regionFilter !== 'All') {
                    filteredApps = filteredApps.filter(app => getITOwnerRegion(app.it_owner) === regionFilter);
                }
                
                const quarters = ['Q1', 'Q2', 'Q3', 'Q4'];
                const aggregated = {};
                quarters.forEach(q => { aggregated[q] = { 'Retire': 0, 'Replace': 0, 'Remain': 0 }; });
                
                filteredApps.forEach(app => {
                    quarters.forEach((quarter, idx) => {
                        const currentQuarterIdx = idx;
                        
                        // üî¥ RETIRE / üîµ REPLACE : v√©rifier si c'est l'ann√©e et le trimestre de l'action
                        if (app['7R_action_year'] === year && app['7R_action_month']) {
                            const appQuarter = app['7R_action_month'].toUpperCase();  // "q1" ‚Üí "Q1"
                            if (appQuarter === quarter) {
                                if (app['7R_analysis'] === 'Retire') aggregated[quarter]['Retire']++;
                                else if (app['7R_analysis'] === 'Replace') aggregated[quarter]['Replace']++;
                            }
                        }
                        
                        // üü¢ REMAIN : si active cette ann√©e
                        if (app.active_years && app.active_years.includes(year)) {
                            const nextYear = String(parseInt(year) + 1);
                            
                            // Cas 1 : L'app continue l'ann√©e suivante ‚Üí reste dans tous les trimestres
                            if (app.active_years.includes(nextYear)) {
                                // Sauf si elle est retir√©e/remplac√©e ce trimestre pr√©cis
                                const appQuarter = app['7R_action_month'] ? app['7R_action_month'].toUpperCase() : null;
                                if (!(app['7R_action_year'] === year && appQuarter === quarter)) {
                                    aggregated[quarter]['Remain']++;
                                }
                            }
                            // Cas 2 : L'app se termine cette ann√©e ‚Üí reste jusqu'√† son trimestre d'action
                            else if (app['7R_action_year'] === year && app['7R_action_month']) {
                                const actionQuarter = app['7R_action_month'].toUpperCase();
                                const actionQuarterIdx = quarters.indexOf(actionQuarter);
                                
                                // Si on est AVANT le trimestre d'action
                                if (currentQuarterIdx < actionQuarterIdx) {
                                    aggregated[quarter]['Remain']++;
                                }
                            }
                        }
                    });
                });
                
                const ctx = document.getElementById('decommChart').getContext('2d');
                if (decommChart) decommChart.destroy();
                
                // Plugin pour afficher les nombres
                const datalabelsPlugin = {
                    id: 'datalabels',
                    afterDatasetsDraw(chart) {
                        const ctx = chart.ctx;
                        chart.data.datasets.forEach((dataset, datasetIndex) => {
                            const meta = chart.getDatasetMeta(datasetIndex);
                            meta.data.forEach((bar, index) => {
                                const value = dataset.data[index];
                                if (value > 0) {
                                    const barHeight = Math.abs(bar.base - bar.y);
                                    const minHeight = 30; // Hauteur minimale pour afficher le texte dedans
                                    
                                    ctx.font = 'bold 20px Arial';
                                    ctx.fillStyle = dataset.backgroundColor;
                                    
                                    // Si la barre est trop petite, afficher √† c√¥t√©
                                    if (barHeight < minHeight) {
                                        const yPos = (bar.y + bar.base) / 2;
                                        
                                        if (datasetIndex === 2) { // Retire (rouge) - √† gauche
                                            ctx.textAlign = 'right';
                                            ctx.textBaseline = 'middle';
                                            ctx.fillText(value, bar.x - bar.width/2 - 5, yPos);
                                        } else if (datasetIndex === 1) { // Replace (bleu) - √† droite
                                            ctx.textAlign = 'left';
                                            ctx.textBaseline = 'middle';
                                            ctx.fillText(value, bar.x + bar.width/2 + 5, yPos);
                                        } else { // Remain (vert) - centr√© au-dessus
                                            ctx.textAlign = 'center';
                                            ctx.textBaseline = 'bottom';
                                            ctx.fillText(value, bar.x, bar.y - 5);
                                        }
                                    } else {
                                        // Sinon afficher au centre en blanc
                                        ctx.fillStyle = '#fff';
                                        ctx.textAlign = 'center';
                                        ctx.textBaseline = 'middle';
                                        const yPos = (bar.y + bar.base) / 2;
                                        ctx.fillText(value, bar.x, yPos);
                                    }
                                }
                            });
                        });
                    }
                };
                
                decommChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: quarters.map(q => `${q} ${year}`),
                        datasets: [
                            { label: 'Remain', data: quarters.map(q => aggregated[q]['Remain']), backgroundColor: '#388e3c' },
                            { label: 'Replace', data: quarters.map(q => aggregated[q]['Replace']), backgroundColor: '#1976d2' },
                            { label: 'Retire', data: quarters.map(q => aggregated[q]['Retire']), backgroundColor: '#d32f2f' }
                        ]
                    },
                    plugins: [datalabelsPlugin],
                    options: { 
                        scales: { 
                            x: { 
                                stacked: true,
                                ticks: {
                                    font: { size: 24, weight: 'bold', family: 'Arial, sans-serif', style: 'italic' },
                                    color: '#1976d2'
                                }
                            }, 
                            y: { stacked: true, beginAtZero: true } 
                        },
                        plugins: {
                            tooltip: { enabled: true },
                            legend: { display: true }
                        },
                        onClick: (e, active) => {
                            if (active.length > 0) {
                                const idx = active[0].index;
                                const label = decommChart.data.datasets[active[0].datasetIndex].label;
                                const quarter = quarters[idx];
                                
                                // Afficher les d√©tails du trimestre cliqu√©
                                let filtered = [];
                                if (label === 'Retire' || label === 'Replace') {
                                    filtered = filteredApps.filter(a => {
                                        if (a['7R_action_year'] === year && a['7R_action_month'] && a['7R_analysis'] === label) {
                                            return a['7R_action_month'].toUpperCase() === quarter;
                                        }
                                        return false;
                                    });
                                } else if (label === 'Remain') {
                                    // Filtrer les applications Remain pour ce trimestre
                                    const quarterIdx = quarters.indexOf(quarter);
                                    const nextYear = String(parseInt(year) + 1);
                                    
                                    filtered = filteredApps.filter(a => {
                                        if (!a.active_years || !a.active_years.includes(year)) return false;
                                        
                                        // Cas 1 : L'app continue l'ann√©e suivante
                                        if (a.active_years.includes(nextYear)) {
                                            // Sauf si elle est retir√©e/remplac√©e ce trimestre pr√©cis
                                            const appQuarter = a['7R_action_month'] ? a['7R_action_month'].toUpperCase() : null;
                                            return !(a['7R_action_year'] === year && appQuarter === quarter);
                                        }
                                        // Cas 2 : L'app se termine cette ann√©e ‚Üí reste jusqu'√† son trimestre d'action
                                        else if (a['7R_action_year'] === year && a['7R_action_month']) {
                                            const actionQuarter = a['7R_action_month'].toUpperCase();
                                            const actionQuarterIdx = quarters.indexOf(actionQuarter);
                                            // Si on est AVANT le trimestre d'action
                                            return quarterIdx < actionQuarterIdx;
                                        }
                                        return false;
                                    });
                                }
                                
                                const detailsDiv = document.getElementById('bar-chart-details');
                                detailsDiv.style.display = 'block';
                                const colorMap = { 'Retire': '#d32f2f', 'Replace': '#1976d2', 'Remain': '#388e3c' };
                                let h = `<h4>${label} - ${quarter} ${year} - ${filtered.length} app(s)</h4><div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(250px, 1fr)); gap:10px;">`;
                                filtered.forEach(a => {
                                    let actionInfo = '';
                                    if ((label === 'Replace' || label === 'Retire') && a['7R_action_year'] && a['7R_action_month']) {
                                        actionInfo = `<br><span style="font-size: 14px;">7R : ${a['7R_action_month'].toUpperCase()} ${a['7R_action_year']}</span>`;
                                    }
                                    if (label === 'Replace' && a['replace_by']) {
                                        actionInfo += `<br><span style="font-size: 14px;">Replace by: ${a['replace_by']}</span>`;
                                    }
                                    h += `<div style="background:#fff; padding:10px; border-radius:5px; border-left:4px solid ${colorMap[label]};">
                                        <b style="font-size: 18px;">${a.name}</b><br><span style="font-size: 14px;">üåç ${a.regions ? a.regions.map(r => r.toUpperCase()).join(', ') : 'N/A'} | Quarter: ${a['7R_action_month'] || 'N/A'}</span><br><span style="font-size: 14px;">üë§ IT Owner: ${a.it_owner || 'N/A'}</span>${actionInfo}
                                    </div>`;
                                });
                                h += `</div>`;
                                document.getElementById('bar-chart-details-content').innerHTML = h;
                                
                                // Scroll pour afficher la zone de d√©tails (cacher le bas du graphique)
                                setTimeout(() => {
                                    const canvas = document.getElementById('decommChart');
                                    const canvasRect = canvas.getBoundingClientRect();
                                    const canvasBottom = canvasRect.bottom + window.scrollY;
                                    
                                    // Scroll pour que le bas du graphique soit en haut de la fen√™tre (+ petite marge)
                                    window.scrollTo({ top: canvasBottom - 50, behavior: 'smooth' });
                                }, 100);
                            }
                        }
                    }
                });
            });
        }
        
        function loadSummary() {
            fetch('data.json').then(r => r.json()).then(apps => {
                const years = ['2025', '2026', '2027', '2028'];
                const summary = {};
                years.forEach(year => { summary[year] = { retire: 0, replace: 0, tco: 0 }; });
                apps.forEach(app => {
                    // Exclure Matrix (car c'est la fusion de ses variantes)
                    if (app.name === 'Matrix') return;
                    
                    const year = app['7R_action_year'];
                    if (years.includes(year)) {
                        if (app['7R_analysis'] === 'Retire') summary[year].retire++;
                        else if (app['7R_analysis'] === 'Replace') summary[year].replace++;
                        if (app.tco) summary[year].tco += app.tco;
                    }
                });
                let html = '';
                years.forEach(year => {
                    html += `<tr>
                        <td style="padding:8px 6px; text-align:center; font-weight:bold; color:#1976d2;">${year}</td>
                        <td style="padding:8px 6px; text-align:center; color:#d32f2f; font-weight:bold;">${summary[year].retire}</td>
                        <td style="padding:8px 6px; text-align:center; color:#1976d2; font-weight:bold;">${summary[year].replace}</td>
                        <td style="padding:8px 6px; text-align:center; color:#7b1fa2; font-weight:bold;">$${summary[year].tco.toLocaleString('fr-FR', {maximumFractionDigits: 0})}</td>
                    </tr>`;
                });
                document.getElementById('year-summary-tbody').innerHTML = html;
            });
        }

        function loadChartData(regionFilter = 'All') {
            fetch('data.json').then(r => r.json()).then(apps => {
                // Exclure Matrix (car c'est la fusion de ses variantes)
                let filteredApps = apps.filter(app => app.name !== 'Matrix');
                
                // Filtrer par r√©gion IT Owner si n√©cessaire
                if (regionFilter !== 'All') {
                    filteredApps = filteredApps.filter(app => getITOwnerRegion(app.it_owner) === regionFilter);
                }
                
                const years = ['2025', '2026', '2027', '2028'];
                const aggregated = {};
                years.forEach(year => { aggregated[year] = { 'Retire': 0, 'Replace': 0, 'Remain': 0 }; });
                
                filteredApps.forEach(app => {
                    years.forEach((year, idx) => {
                        const nextYear = String(parseInt(year) + 1);
                        
                        // üî¥ RETIRE : 7R_action_year === ann√©e ET 7R_analysis === "Retire"
                        if (app['7R_action_year'] === year && app['7R_analysis'] === 'Retire') {
                            aggregated[year]['Retire']++;
                        }
                        // üîµ REPLACE : 7R_action_year === ann√©e ET 7R_analysis === "Replace"
                        else if (app['7R_action_year'] === year && app['7R_analysis'] === 'Replace') {
                            aggregated[year]['Replace']++;
                        }
                        // üü¢ REMAIN : active cette ann√©e ET l'ann√©e suivante
                        else if (app.active_years && 
                                 app.active_years.includes(year) && 
                                 app.active_years.includes(nextYear)) {
                            aggregated[year]['Remain']++;
                        }
                    });
                });
                
                const ctx = document.getElementById('decommChart').getContext('2d');
                if (decommChart) decommChart.destroy();
                
                // Plugin pour afficher les nombres sur les barres
                const datalabelsPlugin = {
                    id: 'datalabels',
                    afterDatasetsDraw(chart) {
                        const ctx = chart.ctx;
                        chart.data.datasets.forEach((dataset, datasetIndex) => {
                            const meta = chart.getDatasetMeta(datasetIndex);
                            meta.data.forEach((bar, index) => {
                                const value = dataset.data[index];
                                if (value > 0) {
                                    const barHeight = Math.abs(bar.base - bar.y);
                                    const minHeight = 30; // Hauteur minimale pour afficher le texte dedans
                                    
                                    ctx.font = 'bold 20px Arial';
                                    ctx.fillStyle = dataset.backgroundColor;
                                    
                                    // Si la barre est trop petite, afficher √† c√¥t√©
                                    if (barHeight < minHeight) {
                                        const yPos = (bar.y + bar.base) / 2;
                                        
                                        if (datasetIndex === 2) { // Retire (rouge) - √† gauche
                                            ctx.textAlign = 'right';
                                            ctx.textBaseline = 'middle';
                                            ctx.fillText(value, bar.x - bar.width/2 - 5, yPos);
                                        } else if (datasetIndex === 1) { // Replace (bleu) - √† droite
                                            ctx.textAlign = 'left';
                                            ctx.textBaseline = 'middle';
                                            ctx.fillText(value, bar.x + bar.width/2 + 5, yPos);
                                        } else { // Remain (vert) - centr√© au-dessus
                                            ctx.textAlign = 'center';
                                            ctx.textBaseline = 'bottom';
                                            ctx.fillText(value, bar.x, bar.y - 5);
                                        }
                                    } else {
                                        // Sinon afficher au centre en blanc
                                        ctx.fillStyle = '#fff';
                                        ctx.textAlign = 'center';
                                        ctx.textBaseline = 'middle';
                                        const yPos = (bar.y + bar.base) / 2;
                                        ctx.fillText(value, bar.x, yPos);
                                    }
                                }
                            });
                        });
                    }
                };
                
                decommChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: years.map(y => `end of ${y}`),
                        datasets: [
                            { label: 'Remain', data: years.map(y => aggregated[y]['Remain']), backgroundColor: '#388e3c' },
                            { label: 'Replace', data: years.map(y => aggregated[y]['Replace']), backgroundColor: '#1976d2' },
                            { label: 'Retire', data: years.map(y => aggregated[y]['Retire']), backgroundColor: '#d32f2f' }
                        ]
                    },
                    plugins: [datalabelsPlugin],
                    options: { 
                        scales: { 
                            x: { 
                                stacked: true,
                                ticks: {
                                    font: { size: 24, weight: 'bold', family: 'Arial, sans-serif', style: 'italic' },
                                    color: '#1976d2',
                                    cursor: 'pointer',
                                    backdropColor: 'rgba(25, 118, 210, 0.1)',
                                    backdropPadding: 4
                                }
                            }, 
                            y: { stacked: true, beginAtZero: true } 
                        },
                        plugins: {
                            tooltip: { enabled: true },
                            legend: { display: true }
                        },
                        onClick: (e, active) => {
                            if (active.length > 0) {
                                const idx = active[0].index;
                                const label = decommChart.data.datasets[active[0].datasetIndex].label;
                                const year = years[idx];
                                const nextYear = String(parseInt(year) + 1);
                                let filtered;
                                
                                if (label === 'Retire') {
                                    filtered = filteredApps.filter(a => a['7R_action_year'] === year && a['7R_analysis'] === 'Retire');
                                } else if (label === 'Replace') {
                                    filtered = filteredApps.filter(a => a['7R_action_year'] === year && a['7R_analysis'] === 'Replace');
                                } else if (label === 'Remain') {
                                    filtered = filteredApps.filter(a => a.active_years && 
                                        a.active_years.includes(year) && 
                                        a.active_years.includes(nextYear));
                                }
                                
                                const detailsDiv = document.getElementById('bar-chart-details');
                                detailsDiv.style.display = 'block';
                                const colorMap = { 'Retire': '#d32f2f', 'Replace': '#1976d2', 'Remain': '#388e3c' };
                                let h = `<h4>${label} (${year}) - ${filtered.length} app(s)</h4><div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(250px, 1fr)); gap:10px;">`;
                                filtered.forEach(a => {
                                    let actionInfo = '';
                                    if ((label === 'Replace' || label === 'Retire') && a['7R_action_year'] && a['7R_action_month']) {
                                        actionInfo = `<br><span style="font-size: 14px;">7R : ${a['7R_action_month'].toUpperCase()} ${a['7R_action_year']}</span>`;
                                    }
                                    if (label === 'Replace' && a['replace_by']) {
                                        actionInfo += `<br><span style="font-size: 14px;">Replace by: ${a['replace_by']}</span>`;
                                    }
                                    h += `<div style="background:#fff; padding:10px; border-radius:5px; border-left:4px solid ${colorMap[label]};">
                                        <b style="font-size: 18px;">${a.name}</b><br><span style="font-size: 14px;">üåç ${a.regions ? a.regions.map(r => r.toUpperCase()).join(', ') : 'N/A'}</span><br><span style="font-size: 14px;">üë§ IT Owner: ${a.it_owner || 'N/A'}</span>${actionInfo}
                                    </div>`;
                                });
                                h += `</div>`;
                                document.getElementById('bar-chart-details-content').innerHTML = h;
                                
                                // Scroll pour afficher la zone de d√©tails (cacher le bas du graphique)
                                setTimeout(() => {
                                    const canvas = document.getElementById('decommChart');
                                    const canvasRect = canvas.getBoundingClientRect();
                                    const canvasBottom = canvasRect.bottom + window.scrollY;
                                    
                                    // Scroll pour que le bas du graphique soit en haut de la fen√™tre (+ petite marge)
                                    window.scrollTo({ top: canvasBottom - 50, behavior: 'smooth' });
                                }, 100);
                            }
                        }
                    }
                });
            });
        }

        function exportToExcel() {
            fetch('data.json').then(r => r.json()).then(apps => {
                const wb = XLSX.utils.book_new();
                const years = ['2025', '2026', '2027', '2028'];
                
                // Fonction pour d√©terminer le Current State
                function getCurrentState(app) {
                    const now = new Date();
                    const currentYear = now.getFullYear();
                    const currentMonth = now.getMonth() + 1; // 1-12
                    
                    // D√©terminer le trimestre actuel
                    let currentQuarter;
                    if (currentMonth <= 3) currentQuarter = 'Q1';
                    else if (currentMonth <= 6) currentQuarter = 'Q2';
                    else if (currentMonth <= 9) currentQuarter = 'Q3';
                    else currentQuarter = 'Q4';
                    
                    const quarterOrder = {'Q1': 1, 'Q2': 2, 'Q3': 3, 'Q4': 4};
                    
                    // V√©rifier si l'app a une action (Retire ou Replace) dans le pass√©
                    if (app['7R_action_year'] && app['7R_action_month'] && 
                        (app['7R_analysis'] === 'Retire' || app['7R_analysis'] === 'Replace')) {
                        
                        const actionYear = parseInt(app['7R_action_year']);
                        const actionQuarter = app['7R_action_month'].toUpperCase();
                        
                        // Si action dans une ann√©e pass√©e ‚Üí Retired
                        if (actionYear < currentYear) {
                            return 'Retired';
                        }
                        // Si action cette ann√©e mais trimestre pass√© ‚Üí Retired
                        else if (actionYear === currentYear && 
                                 quarterOrder[actionQuarter] < quarterOrder[currentQuarter]) {
                            return 'Retired';
                        }
                    }
                    
                    return 'Production';
                }
                
                // Cr√©er la feuille consolid√©e 2025-2028 (sans doublons)
                const uniqueApps = new Map();
                
                apps.forEach(app => {
                    // Exclure Matrix de l'export
                    if (app.name === 'Matrix') return;
                    
                    const appName = app.name;
                    
                    // Si l'app a une action Retire ou Replace, l'enregistrer
                    if (app['7R_action_year'] && (app['7R_analysis'] === 'Retire' || app['7R_analysis'] === 'Replace')) {
                        uniqueApps.set(appName, {
                            currentState: getCurrentState(app),
                            actionYear: app['7R_action_year'],
                            status: app['7R_analysis'],
                            name: appName,
                            itOwnerRegion: getITOwnerRegion(app.it_owner) || '',
                            actionMonth: app['7R_action_month'] ? app['7R_action_month'].toUpperCase() : '',
                            tco: app.tco || ''
                        });
                    }
                    // Sinon, si l'app n'est pas d√©j√† enregistr√©e et est active, l'ajouter comme Remain
                    else if (!uniqueApps.has(appName) && app.active_years && app.active_years.length > 0) {
                        uniqueApps.set(appName, {
                            currentState: getCurrentState(app),
                            actionYear: '',
                            status: 'Remain',
                            name: appName,
                            itOwnerRegion: getITOwnerRegion(app.it_owner) || '',
                            actionMonth: '',
                            tco: app.tco || ''
                        });
                    }
                });
                
                // Cr√©er la feuille consolid√©e
                const consolidatedData = [];
                consolidatedData.push(['Current State', '7R Year', '7R Analysis', 'Application Name', 'Region IT Owner', '7R Quarter', 'TCO']);
                
                // Convertir la Map en tableau et trier
                const sortedApps = Array.from(uniqueApps.values()).sort((a, b) => {
                    // 1. Retired avant Production
                    if (a.currentState === 'Retired' && b.currentState === 'Production') return -1;
                    if (a.currentState === 'Production' && b.currentState === 'Retired') return 1;
                    
                    // 2. Trier par 7R Year (2025, 2026, 2027, 2028)
                    const yearA = parseInt(a.actionYear) || 9999;
                    const yearB = parseInt(b.actionYear) || 9999;
                    if (yearA !== yearB) return yearA - yearB;
                    
                    // 3. Trier par 7R Analysis : Retire avant Replace avant Remain
                    const analysisOrder = { 'Retire': 1, 'Replace': 2, 'Remain': 3 };
                    const orderA = analysisOrder[a.status] || 4;
                    const orderB = analysisOrder[b.status] || 4;
                    if (orderA !== orderB) return orderA - orderB;
                    
                    // 4. Trier par 7R Month (Q1 ‚Üí Q2 ‚Üí Q3 ‚Üí Q4)
                    const monthOrder = { 'Q1': 1, 'Q2': 2, 'Q3': 3, 'Q4': 4 };
                    const monthA = monthOrder[a.actionMonth] || 9999;
                    const monthB = monthOrder[b.actionMonth] || 9999;
                    if (monthA !== monthB) return monthA - monthB;
                    
                    // 5. Si tout est √©gal, trier par nom d'application
                    return a.name.localeCompare(b.name);
                });
                
                // Fonction helper pour ajouter un groupe d'apps avec total
                function addAppsWithTotal(apps, titlePrefix) {
                    apps.forEach(app => {
                        consolidatedData.push([
                            app.currentState,
                            app.actionYear,
                            app.status,
                            app.name,
                            app.itOwnerRegion,
                            app.actionMonth,
                            app.tco
                        ]);
                    });
                    
                    if (apps.length > 0) {
                        const count = apps.length;
                        const tcoTotal = apps.reduce((sum, app) => {
                            const tco = parseFloat(app.tco) || 0;
                            return sum + tco;
                        }, 0);
                        
                        consolidatedData.push([
                            `TOTAL ${titlePrefix}`,
                            '',
                            '',
                            `${count} applications`,
                            '',
                            '',
                            tcoTotal
                        ]);
                    }
                }
                
                // S√©parer Retired et Production
                const retiredApps = sortedApps.filter(app => app.currentState === 'Retired');
                const productionApps = sortedApps.filter(app => app.currentState === 'Production');
                
                // Ajouter les Retired avec total
                addAppsWithTotal(retiredApps, 'RETIRED');
                
                // Ajouter les Production par ann√©e avec totaux
                years.forEach(year => {
                    const yearApps = productionApps.filter(app => app.actionYear === year);
                    addAppsWithTotal(yearApps, year);
                });
                
                // Ajouter les Production sans ann√©e (Remain sans action)
                const noYearApps = productionApps.filter(app => !app.actionYear);
                addAppsWithTotal(noYearApps, 'PRODUCTION (No planned action)');
                
                const wsConsolidated = XLSX.utils.aoa_to_sheet(consolidatedData);
                wsConsolidated['!cols'] = [
                    { wch: 15 }, // Current State
                    { wch: 10 }, // 7R Year
                    { wch: 12 }, // 7R Analysis
                    { wch: 30 }, // Application Name
                    { wch: 20 }, // Region IT Owner
                    { wch: 12 }, // 7R Month
                    { wch: 15 }  // TCO
                ];
                XLSX.utils.book_append_sheet(wb, wsConsolidated, '2025-2028');
                
                // T√©l√©charger le fichier
                XLSX.writeFile(wb, 'Decommissioning_Plan.xlsx');
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            loadSummary();
            loadChartData();
            
            // Ajouter l'√©v√©nement au bouton d'export
            document.getElementById('export-excel-btn').addEventListener('click', exportToExcel);
        });
    </script>
</body>
</html>