<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Decommissioning Plan</title>
    <link rel="stylesheet" href="Decomm-styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div id="banner">
        <img src="CEVA_BlueRed.jpg" alt="CEVA Logistics" id="banner-logo">
        <h1>Decommissioning Planning Tool</h1>
    </div>
    
    <div class="container">
        <div class="header">
            <button class="back-button" onclick="window.close()">‚Üê Back</button>
            <h1 style="color: white;">Decommissioning Plan</h1>
            <p>Plan and track application decommissioning activities</p>
        </div>
        
        <div class="comparison-area">
            <div id="summary-section" style="background:#f8f9fa; border:2px solid #1976d2; border-radius:12px; padding:20px; margin-bottom:30px;">
                <h3 style="text-align:center; color:#1976d2; margin-top:0; margin-bottom:20px;">Decommissioning Overview</h3>
                <div id="year-summary-table" style="overflow-x:auto;">
                    <table style="width:100%; border-collapse:collapse; background:#fff; font-size:1.3em;">
                        <thead>
                            <tr style="background:#f0f4fa; color:#1976d2;">
                                <th style="padding:14px 10px; border-bottom:3px solid #1976d2; font-size:1em;">Year</th>
                                <th style="padding:14px 10px; border-bottom:3px solid #1976d2; font-size:1em;">Retire</th>
                                <th style="padding:14px 10px; border-bottom:3px solid #1976d2; font-size:1em;">Replace</th>
                                <th style="padding:14px 10px; border-bottom:3px solid #1976d2; font-size:1em;">TCO ($)</th>
                            </tr>
                        </thead>
                        <tbody id="year-summary-tbody"></tbody>
                    </table>
                </div>
            </div>
            
            <div style="display:flex; justify-content:center; gap:20px; margin-bottom:20px;">
                <button id="btnView1" class="slider-btn active" onclick="showView(1)">Bar Chart by Region</button>
                <button id="btnView2" class="slider-btn" onclick="showView(2)">Sunset Roadmap</button>
                <button id="btnView4" class="slider-btn" onclick="showView(4)">TCO Optimization Flow</button>
                <button id="btnView3" class="slider-btn" onclick="showView(3)">Decomm Plan Table</button>
            </div>
            
            <div id="view1" class="chart-view">
                <div style="background:#fff; border:1px solid #ddd; border-radius:16px; box-shadow:0 2px 12px #0002; padding:30px; margin-bottom:30px;">
                    <h3 style="text-align:center; color:#1976d2; margin-bottom:20px;">Decommissioning Plan by Year (2025-2028)</h3>
                    <canvas id="decommChart" width="800" height="400"></canvas>
                </div>
            </div>
            
            <div id="bar-chart-details" style="display:none; margin-top:20px; padding:20px; background:#f5f5f5; border-radius:8px;">
                <div id="bar-chart-details-content"></div>
            </div>
            
            <div id="view2" class="chart-view" style="display:none;">
                <div style="background:#fff; border:1px solid #ddd; border-radius:16px; box-shadow:0 2px 12px #0002; padding:30px; margin-bottom:30px;">
                    <h3 style="text-align:center; color:#1976d2; margin-bottom:20px;">Sunset Roadmap</h3>
                    
                    <div style="display:flex; justify-content:center; gap:10px; margin-bottom:20px; flex-wrap:wrap;">
                        <button class="region-tab active" onclick="filterGanttByRegion('All')">All Regions</button>
                        <button class="region-tab" onclick="filterGanttByRegion('apac')" style="--tab-color:#d32f2f;">APAC</button>
                        <button class="region-tab" onclick="filterGanttByRegion('europe')" style="--tab-color:#1976d2;">EUROPE</button>
                        <button class="region-tab" onclick="filterGanttByRegion('imea')" style="--tab-color:#7b1fa2;">IMEA</button>
                        <button class="region-tab" onclick="filterGanttByRegion('latam')" style="--tab-color:#388e3c;">LATAM</button>
                        <button class="region-tab" onclick="filterGanttByRegion('nortam')" style="--tab-color:#f57c00;">NORTAM</button>
                    </div>
                    
                    <div id="customGanttChart"></div>
                </div>
            </div>
            
            <div id="view3" class="chart-view" style="display:none;">
                <div id="result"></div>
            </div>
            
            <div id="view4" class="chart-view" style="display:none;">
                <div style="background:#fff; border:1px solid #ddd; border-radius:16px; box-shadow:0 2px 12px #0002; padding:30px; margin-bottom:30px;">
                    <h3 style="text-align:center; color:#1976d2; margin-bottom:20px;">Replacement Applications Flow</h3>
                    <div style="display:flex; justify-content:center; gap:10px; margin-bottom:20px; flex-wrap:wrap;">
                        <button class="year-tab active" onclick="filterReplacedByYear(2025)" style="padding:10px 20px; border:2px solid #1976d2; background:#1976d2; color:white; border-radius:8px; cursor:pointer; font-weight:bold; transition:all 0.3s;">2025</button>
                        <button class="year-tab" onclick="filterReplacedByYear(2026)" style="padding:10px 20px; border:2px solid #1976d2; background:white; color:#1976d2; border-radius:8px; cursor:pointer; font-weight:bold; transition:all 0.3s;">2026</button>
                        <button class="year-tab" onclick="filterReplacedByYear(2027)" style="padding:10px 20px; border:2px solid #1976d2; background:white; color:#1976d2; border-radius:8px; cursor:pointer; font-weight:bold; transition:all 0.3s;">2027</button>
                        <button class="year-tab" onclick="filterReplacedByYear(2028)" style="padding:10px 20px; border:2px solid #1976d2; background:white; color:#1976d2; border-radius:8px; cursor:pointer; font-weight:bold; transition:all 0.3s;">2028</button>
                    </div>
                    <div id="replacedByChart" style="position:relative; min-height:600px; overflow:auto;"></div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let decommChart = null;
        let currentRegionFilter = 'All';
        
        function showView(viewNumber) {
            document.getElementById('view1').style.display = 'none';
            document.getElementById('view2').style.display = 'none';
            document.getElementById('view3').style.display = 'none';
            document.getElementById('view4').style.display = 'none';
            document.getElementById('bar-chart-details').style.display = 'none';
            document.querySelectorAll('.slider-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('view' + viewNumber).style.display = 'block';
            document.getElementById('btnView' + viewNumber).classList.add('active');
            if (viewNumber === 4) { loadReplacedByChart(2025); }
        }
        
        function filterGanttByRegion(targetRegion) {
            currentRegionFilter = targetRegion;
            document.querySelectorAll('.region-tab').forEach(btn => btn.classList.remove('active'));
            if(event) event.target.classList.add('active');
            loadGanttChart(targetRegion);
        }
        
        function loadSummary() {
            fetch('data.json').then(r => r.json()).then(apps => {
                const years = ['2025', '2026', '2027', '2028'];
                const summary = {};
                years.forEach(year => { summary[year] = { retire: 0, replace: 0, tco: 0 }; });
                apps.forEach(app => {
                    const year = app['7R_action_year'];
                    if (years.includes(year)) {
                        if (app['7R_analysis'] === 'Retire') summary[year].retire++;
                        else if (app['7R_analysis'] === 'Replace') summary[year].replace++;
                        if (app.tco) summary[year].tco += app.tco;
                    }
                });
                let html = '';
                years.forEach(year => {
                    html += `<tr>
                        <td style="padding:8px 6px; text-align:center; font-weight:bold; color:#1976d2;">${year}</td>
                        <td style="padding:8px 6px; text-align:center; color:#d32f2f; font-weight:bold;">${summary[year].retire}</td>
                        <td style="padding:8px 6px; text-align:center; color:#388e3c; font-weight:bold;">${summary[year].replace}</td>
                        <td style="padding:8px 6px; text-align:center; color:#7b1fa2; font-weight:bold;">$${summary[year].tco.toLocaleString('fr-FR', {maximumFractionDigits: 0})}</td>
                    </tr>`;
                });
                document.getElementById('year-summary-tbody').innerHTML = html;
            });
        }
        
        function loadReplacedByChart(yearFilter = 'All') {
            fetch('data.json').then(r => r.json()).then(apps => {
                let appsWithReplacement = apps.filter(app => app.replace_by && app.replace_by.trim() !== '');
                if (yearFilter !== 'All') { appsWithReplacement = appsWithReplacement.filter(app => app['7R_action_year'] == yearFilter); }
                
                const replacementGroups = {};
                appsWithReplacement.forEach(app => {
                    const replaceBy = app.replace_by;
                    if (!replacementGroups[replaceBy]) {
                        replacementGroups[replaceBy] = { name: replaceBy, apps: [], totalTco: 0 };
                    }
                    replacementGroups[replaceBy].apps.push(app);
                    replacementGroups[replaceBy].totalTco += (app.tco || 0);
                });
                
                const replacements = Object.values(replacementGroups).sort((a, b) => b.totalTco - a.totalTco);
                const maxTco = replacements.length > 0 ? replacements[0].totalTco : 1;
                const container = document.getElementById('replacedByChart');
                let html = '<svg width="100%" height="' + (replacements.length * 150 + 150) + '" style="position:absolute; top:0; left:0; pointer-events:none;" id="arrowsSvg"></svg>';
                html += '<div style="position:relative; padding-top:50px;">';
                
                replacements.forEach((replacement, index) => {
                    const yPos = index * 150 + 50;
                    const minSize = 60; const maxSize = 150;
                    const bubbleSize = minSize + (replacement.totalTco / maxTco) * (maxSize - minSize);
                    
                    html += `<div style="position:absolute; left:50%; top:${yPos}px; transform:translateX(-50%); display:flex; align-items:center; gap:20px;">
                        <div style="width:${bubbleSize}px; height:${bubbleSize}px; border-radius:50%; background:linear-gradient(135deg, #1976d2, #42a5f5); display:flex; align-items:center; justify-content:center; color:white; font-weight:bold; text-align:center; padding:10px; box-shadow:0 4px 12px rgba(25,118,210,0.4);">
                            <div style="font-size:${Math.max(10, bubbleSize/8)}px;">${replacement.name}</div>
                        </div>
                        <div style="font-size:12px; color:#666;">
                            <div style="font-weight:bold; color:#1976d2; font-size:16px;">‚Ç¨${replacement.totalTco.toLocaleString('fr-FR')}</div>
                            <div>${replacement.apps.length} app(s)</div>
                        </div>
                    </div>`;
                    
                    const appsPerColumn = Math.ceil(replacement.apps.length / 2);
                    replacement.apps.forEach((app, appIndex) => {
                        const column = Math.floor(appIndex / appsPerColumn);
                        const row = appIndex % appsPerColumn;
                        const xPos = column * 250 + 50;
                        const appYPos = yPos + row * 35 - (appsPerColumn * 35) / 2 + 20;
                        const regionColors = { 'apac': '#d32f2f', 'europe': '#1976d2', 'imea': '#7b1fa2', 'latam': '#388e3c', 'nortam': '#f57c00' };
                        
                        // Utilise la premi√®re r√©gion du tableau pour la couleur
                        const mainRegion = (app.regions && app.regions.length > 0) ? app.regions[0].toLowerCase() : 'default';
                        
                        html += `<div class="source-app" data-replacement-index="${index}" style="position:absolute; left:${xPos}px; top:${appYPos}px; background:#f5f5f5; padding:8px 12px; border-radius:6px; border-left:4px solid ${regionColors[mainRegion] || '#999'}; font-size:11px; max-width:200px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; box-shadow:0 2px 4px rgba(0,0,0,0.1);" title="${app.name}">${app.name}</div>`;
                    });
                });
                
                html += '</div>';
                container.innerHTML = html;
                
                setTimeout(() => {
                    const svg = document.getElementById('arrowsSvg');
                    let svgContent = '<defs><marker id="arrowhead" markerWidth="10" markerHeight="10" refX="8" refY="3" orient="auto"><polygon points="0 0, 10 3, 0 6" fill="#1976d2" opacity="0.6"/></marker></defs>';
                    document.querySelectorAll('.source-app').forEach(appDiv => {
                        const rIdx = parseInt(appDiv.getAttribute('data-replacement-index'));
                        const rect = appDiv.getBoundingClientRect();
                        const cRect = container.getBoundingClientRect();
                        const x1 = rect.right - cRect.left;
                        const y1 = rect.top - cRect.top + rect.height / 2;
                        const x2 = container.offsetWidth / 2 - 80;
                        const y2 = (rIdx * 150 + 50) + 20;
                        svgContent += `<path d="M ${x1} ${y1} Q ${(x1+x2)/2} ${y1} ${x2} ${y2}" stroke="#1976d2" stroke-width="1.5" fill="none" opacity="0.4" marker-end="url(#arrowhead)"/>`;
                    });
                    svg.innerHTML = svgContent;
                }, 100);
            });
        }

        function filterReplacedByYear(year) {
            document.querySelectorAll('.year-tab').forEach(tab => { tab.style.background = 'white'; tab.style.color = '#1976d2'; });
            if(event) { event.target.style.background = '#1976d2'; event.target.style.color = 'white'; }
            loadReplacedByChart(year);
        }

        function loadChartData() {
            fetch('data.json').then(r => r.json()).then(apps => {
                const years = ['2025', '2026', '2027', '2028'];
                const aggregated = {};
                years.forEach(year => { aggregated[year] = { 'Retire': 0, 'Replace': 0 }; });
                apps.forEach(app => {
                    const year = app['7R_action_year'];
                    if (year && aggregated[year]) {
                        if (app['7R_analysis'] === 'Retire') aggregated[year]['Retire']++;
                        else if (app['7R_analysis'] === 'Replace') aggregated[year]['Replace']++;
                    }
                });
                const ctx = document.getElementById('decommChart').getContext('2d');
                if (decommChart) decommChart.destroy();
                decommChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: years,
                        datasets: [
                            { label: 'Retire', data: years.map(y => aggregated[y]['Retire']), backgroundColor: '#1976d2' },
                            { label: 'Replace', data: years.map(y => aggregated[y]['Replace']), backgroundColor: '#42a5f5' }
                        ]
                    },
                    options: { 
                        scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } },
                        onClick: (e, active) => {
                            if (active.length > 0) {
                                const idx = active[0].index;
                                const label = decommChart.data.datasets[active[0].datasetIndex].label;
                                const year = years[idx];
                                const filtered = apps.filter(a => a['7R_action_year'] === year && a['7R_analysis'] === label);
                                const detailsDiv = document.getElementById('bar-chart-details');
                                detailsDiv.style.display = 'block';
                                let h = `<h4>${label} (${year}) - ${filtered.length} app(s)</h4><div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(250px, 1fr)); gap:10px;">`;
                                filtered.forEach(a => {
                                    h += `<div style="background:#fff; padding:10px; border-radius:5px; border-left:4px solid #1976d2;">
                                        <b>${a.name}</b><br><small>üåç ${a.regions ? a.regions.join(', ') : 'N/A'}</small>
                                    </div>`;
                                });
                                h += `</div>`;
                                document.getElementById('bar-chart-details-content').innerHTML = h;
                            }
                        }
                    }
                });
            });
        }

        function loadGanttChart(regionFilter = 'All') {
            fetch('data.json').then(r => r.json()).then(apps => {
                let filteredApps = apps.filter(app => app['7R_action_year']);
                
                // Correction du filtrage : on v√©rifie si la r√©gion est incluse dans le tableau regions
                if (regionFilter !== 'All') { 
                    filteredApps = filteredApps.filter(app => app.regions && app.regions.includes(regionFilter.toLowerCase())); 
                }
                
                filteredApps.sort((a, b) => parseInt(a['7R_action_year']) - parseInt(b['7R_action_year']));
                const regionColors = { 'apac': '#d32f2f', 'europe': '#1976d2', 'imea': '#7b1fa2', 'latam': '#388e3c', 'nortam': '#f57c00' };
                const mToN = { 'jan': 1, 'feb': 2, 'mar': 3, 'apr': 4, 'may': 5, 'jun': 6, 'jul': 7, 'aug': 8, 'sept': 9, 'oct': 10, 'nov': 11, 'dec': 12 };

                let html = '<div style="display: flex; margin-bottom: 10px; padding-left: 250px;">';
                ['2025', '2026', '2027', '2028'].forEach(y => { html += `<div style="flex: 1; text-align: center; font-weight: bold; border-left: 2px solid #ddd;">${y}</div>`; });
                html += '</div>';

                filteredApps.forEach(app => {
                    const year = parseInt(app['7R_action_year']);
                    const month = app['7R_action_month'] ? mToN[app['7R_action_month']] : 12;
                    const endMonthTotal = (year - 2025) * 12 + month;
                    const width = (endMonthTotal / 48) * 100;
                    const mainReg = (app.regions && app.regions.length > 0) ? app.regions[0].toLowerCase() : 'default';

                    html += `<div style="display: flex; align-items: center; min-height: 35px; border-bottom: 1px solid #f0f0f0;">
                        <div style="width: 250px; padding: 5px; font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${app.name}</div>
                        <div style="flex: 1; position: relative; height: 20px; border-left: 2px solid #ddd;">
                            <div style="position: absolute; left: 0; width: ${width}%; height: 100%; background: ${regionColors[mainReg] || '#999'}; border-radius: 3px;" title="${app.name} (${app.regions})"></div>
                        </div>
                    </div>`;
                });
                document.getElementById('customGanttChart').innerHTML = html;
            });
        }

        function loadDecommissioningData() {
            fetch('data.json').then(r => r.json()).then(apps => {
                let filtered = apps.filter(a => a["7R_action_year"]);
                filtered.sort((a, b) => (parseInt(a["7R_action_year"]) || 9999) - (parseInt(b["7R_action_year"]) || 9999));
                
                let html = `<div class="comparison-table"><table class="capability-table"><thead><tr>
                    <th>Application</th><th>Code</th><th>Regions</th><th>Category</th><th>7R</th><th>Year</th><th>Replace By</th><th>TCO ($)</th>
                </tr></thead><tbody>`;
                
                let currentYear = null;
                filtered.forEach(app => {
                    const year = app["7R_action_year"] || 'Not Planned';
                    if (year !== currentYear) {
                        currentYear = year;
                        html += `<tr class="l1-row"><td colspan="8"><b>Year: ${year}</b></td></tr>`;
                    }
                    html += `<tr class="l2-row">
                        <td>${app.name}</td><td>${app.application_code || ''}</td>
                        <td>${app.regions ? app.regions.join(', ') : 'N/A'}</td>
                        <td>${app.category || ''}</td><td>${app["7R_analysis"]}</td>
                        <td>${app["7R_action_year"] || ''}</td><td>${app.replace_by || ''}</td>
                        <td style="text-align:right;">${app.tco ? app.tco.toLocaleString() : '0'}</td>
                    </tr>`;
                });
                html += '</tbody></table></div>';
                document.getElementById('result').innerHTML = html;
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            loadSummary();
            loadDecommissioningData();
            loadChartData();
            loadGanttChart('All');
        });
    </script>
</body>
</html>